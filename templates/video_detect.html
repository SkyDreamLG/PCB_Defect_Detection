<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCBè§†é¢‘æ£€æµ‹</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* è§†é¢‘æ£€æµ‹ä¸“ç”¨æ ·å¼ */
        .video-container {
            display: flex;
            height: 100vh;
            padding: 16px;
            gap: 16px;
            background: #1e1f2c;
        }

        /* å·¦ä¾§æ§åˆ¶é¢æ¿ */
        .video-control-panel {
            width: 300px;
            background-color: #2a2c3b;
            border: 1px solid #3e4052;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-shrink: 0;
        }

        .video-panel-header {
            padding: 18px 20px;
            background: #1b1e2a;
            border-bottom: 2px solid #3a6ea5;
        }

        .video-panel-header h2 {
            font-size: 1.3rem;
            font-weight: 500;
            color: #fff;
            margin: 0;
        }

        .video-panel-content {
            padding: 20px 18px;
            flex: 1;
            overflow-y: auto;
        }

        .video-panel-section {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid #3e4055;
        }

        .video-panel-section:last-child {
            border-bottom: none;
        }

        .video-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #b0c4de;
            margin-bottom: 16px;
            letter-spacing: 0.5px;
        }

        .video-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            background: #2b3d5c;
            border: 1px solid #4b6f9a;
            color: #ecf3ff;
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: uppercase;
            cursor: pointer;
            transition: 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .video-btn:hover:not(:disabled) {
            background: #31639c;
            border-color: #7aa2d0;
        }

        .video-btn.primary {
            background: #2a4b78;
            border-color: #5e87b9;
        }

        .video-btn.success {
            background: #2d5940;
            border-color: #3f8364;
        }

        .video-btn.danger {
            background: #5a353f;
            border-color: #a56b6b;
            color: #ffd7d7;
        }

        .video-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .video-status {
            background: #1f2130;
            border: 1px solid #3e4055;
            padding: 12px;
            margin-top: 16px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .status-label {
            color: #99a6c2;
        }

        .status-value {
            color: #d4e0fc;
            font-weight: 600;
        }

        .status-value.has-board {
            color: #4f9e7a;
        }

        .status-value.no-board {
            color: #f05454;
        }

        .status-value.has-detection {
            color: #5f9df3;
        }

        /* å³ä¾§å†…å®¹åŒºåŸŸ */
        .video-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow: hidden;
        }

        /* ä¸ŠåŠéƒ¨åˆ† - åŒæ æ˜¾ç¤º */
        .video-top {
            flex: 1;
            display: flex;
            gap: 16px;
            min-height: 0;
        }

        .video-card {
            flex: 1;
            background: #2a2c3b;
            border: 1px solid #3e4052;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .video-card-header {
            padding: 12px 16px;
            background: #1b1e2a;
            border-bottom: 2px solid #3a6ea5;
        }

        .video-card-header h3 {
            font-size: 1rem;
            font-weight: 500;
            color: #d0dcf0;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .video-card-body {
            flex: 1;
            padding: 16px;
            background: #212332;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .video-frame {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border: 2px solid #3b5580;
            background: #141824;
        }

        /* ä¸‹åŠéƒ¨åˆ† - ç¼ºé™·ä¿¡æ¯ */
        .video-bottom {
            height: 200px;
            background: #2a2c3b;
            border: 1px solid #3e4052;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .video-bottom-header {
            padding: 12px 16px;
            background: #1b1e2a;
            border-bottom: 2px solid #c05a5a;
        }

        .video-bottom-header h3 {
            font-size: 1rem;
            font-weight: 500;
            color: #fff;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .defect-list-container {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background: #212332;
        }

        .defect-item {
            background: #1f2537;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-left: 6px solid;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
        }

        .defect-item.missing_hole { border-left-color: #f05454; }
        .defect-item.mouse_bite { border-left-color: #8ecf8e; }
        .defect-item.short_circuit { border-left-color: #5f9df3; }

        .defect-detail {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .defect-label {
            font-size: 0.7rem;
            color: #99a6c2;
            text-transform: uppercase;
        }

        .defect-value {
            font-size: 0.9rem;
            color: #e2e8f0;
            font-weight: 500;
        }

        .no-defect-message {
            text-align: center;
            padding: 40px 16px;
            color: #6f7c9f;
            border: 1px dashed #4b5270;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: #7aa2d0;
            text-decoration: none;
            font-size: 0.9rem;
            padding: 6px 12px;
            border: 1px solid #4b6f9a;
            margin-top: 10px;
        }

        .back-link:hover {
            background: #2a4b78;
            color: white;
        }
    </style>
    <!-- æ‘„åƒå¤´é€‰æ‹©æ¨¡æ€æ¡†æ ·å¼ - è´´å·¦è¾¹æ‚¬æµ® -->
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: transparent;  /* ç§»é™¤é®ç½© */
            pointer-events: none;  /* è®©ç‚¹å‡»ç©¿é€ï¼Œé™¤äº†æ¨¡æ€æ¡†æœ¬èº« */
        }

        .modal-content {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 360px;
            background: #2a2c3b;
            border: 2px solid #3a6ea5;
            border-radius: 8px;
            padding: 0;
            box-shadow: 8px 8px 20px rgba(0, 0, 0, 0.5);
            animation: slideInLeft 0.3s ease;
            pointer-events: auto;  /* æ¨¡æ€æ¡†æœ¬èº«å¯ä»¥ç‚¹å‡» */
        }

        @keyframes slideInLeft {
            from {
                left: -400px;
                opacity: 0;
            }
            to {
                left: 20px;
                opacity: 1;
            }
        }

        .modal-header {
            padding: 15px 20px;
            background: #1b1e2a;
            border-bottom: 2px solid #3a6ea5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px 8px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            color: #fff;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-header h3::before {
            content: "ğŸ“·";
            font-size: 1.2rem;
        }

        .modal-close {
            color: #99a6c2;
            font-size: 24px;
            cursor: pointer;
            font-weight: bold;
            line-height: 1;
        }

        .modal-close:hover {
            color: #fff;
        }

        .modal-body {
            padding: 20px;
            background: #212332;
            border-radius: 0 0 8px 8px;
        }

        /* æ‘„åƒå¤´é€‰æ‹©é€‰é¡¹æ ·å¼ */
        .camera-option {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: #1f2130;
            border: 1px solid #3e4055;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid transparent;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .camera-option:hover {
            background: #2f354a;
            border-color: #5f7aa6;
            transform: translateX(2px);
        }

        .camera-option.selected {
            border-left-color: #3a6ea5;
            background: #262c3d;
            border-color: #3a6ea5;
            box-shadow: 0 2px 8px rgba(58, 110, 165, 0.3);
        }

        .camera-option input[type="radio"] {
            margin-right: 12px;
            accent-color: #3a6ea5;
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .camera-option label {
            flex: 1;
            color: #e0e2e8;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .camera-badge {
            font-size: 0.7rem;
            background: #2a4b78;
            color: #ecf3ff;
            padding: 3px 8px;
            border-radius: 4px;
            margin-left: 10px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            border-top: 1px solid #3e4055;
            padding-top: 20px;
        }

        .modal-footer .video-btn {
            flex: 1;
            margin: 0;
            padding: 10px;
            border-radius: 4px;
        }

        .modal-footer .video-btn.primary {
            background: #2a4b78;
        }

        .modal-footer .video-btn.primary:hover {
            background: #31639c;
        }
    </style>
</head>
<body>
    <div class="video-container">
        <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
        <div class="video-control-panel">
            <div class="video-panel-header">
                <h2>PCBè§†é¢‘æ£€æµ‹</h2>
                <a href="/" class="back-link">â† è¿”å›å›¾ç‰‡æ£€æµ‹</a>
            </div>
            <div class="video-panel-content">
                <!-- æ§åˆ¶æŒ‰é’®ç»„ -->
                <div class="video-panel-section">
                    <div class="video-section-title">æ§åˆ¶æŒ‰é’®</div>
                    <button id="startCameraBtn" class="video-btn primary">
                        ğŸ“· å¯åŠ¨æ‘„åƒå¤´
                    </button>
                    <button id="detectBtn" class="video-btn success" disabled>
                        ğŸ” è¯†åˆ«ç¼ºé™·
                    </button>
                    <button id="saveBtn" class="video-btn" disabled>
                        ğŸ’¾ ä¿å­˜ç»“æœ
                    </button>
                    <button id="stopCameraBtn" class="video-btn danger" disabled>
                        â¹ å…³é—­æ‘„åƒå¤´
                    </button>
                </div>

                <!-- çŠ¶æ€ä¿¡æ¯ -->
                <div class="video-panel-section">
                    <div class="video-section-title">çŠ¶æ€ä¿¡æ¯</div>
                    <div class="video-status">
                        <div class="status-item">
                            <span class="status-label">æ‘„åƒå¤´:</span>
                            <span class="status-value" id="cameraStatus">æœªè¿æ¥</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">ç”µè·¯æ¿æ£€æµ‹:</span>
                            <span class="status-value" id="boardStatus">æœªæ£€æµ‹</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">YOLOæ£€æµ‹:</span>
                            <span class="status-value" id="yoloStatus">æœªæ£€æµ‹</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">ç¼ºé™·æ•°é‡:</span>
                            <span class="status-value" id="defectCount">0</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">ä¿å­˜æ¬¡æ•°:</span>
                            <span class="status-value" id="saveCount">0</span>
                        </div>
                    </div>
                </div>

                <!-- æç¤ºä¿¡æ¯ -->
                <div class="video-panel-section">
                    <div class="video-section-title">ä½¿ç”¨è¯´æ˜</div>
                    <div style="color: #99a6c2; font-size: 0.85rem; line-height: 1.6;">
                        <p>1. ç‚¹å‡»"å¯åŠ¨æ‘„åƒå¤´"å¼€å§‹é‡‡é›†</p>
                        <p>2. ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹ç”»é¢ä¸­çš„ç”µè·¯æ¿ï¼ˆç»¿è‰²æ¡†ï¼‰</p>
                        <p>3. ç‚¹å‡»"è¯†åˆ«ç¼ºé™·"å¯¹å½“å‰å¸§è¿›è¡ŒYOLOæ£€æµ‹</p>
                        <p>4. ç‚¹å‡»"ä¿å­˜ç»“æœ"ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆä¿å­˜åéœ€å†æ¬¡æ£€æµ‹ï¼‰</p>
                        <p>5. æ¯å¼ å›¾ç‰‡åªæ£€æµ‹ä¸€ä¸ªç”µè·¯æ¿</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§å†…å®¹åŒºåŸŸ -->
        <div class="video-content">
            <!-- ä¸ŠåŠéƒ¨åˆ†ï¼šåŒæ æ˜¾ç¤º -->
            <div class="video-top">
                <!-- å·¦ä¾§ï¼šæ‘„åƒå¤´ç”»é¢ -->
                <div class="video-card">
                    <div class="video-card-header">
                        <h3>ğŸ“¹ æ‘„åƒå¤´ç”»é¢ï¼ˆç”µè·¯æ¿æ£€æµ‹ï¼‰</h3>
                    </div>
                    <div class="video-card-body">
                        <img id="cameraFeed" class="video-frame" src="" alt="æ‘„åƒå¤´ç”»é¢">
                    </div>
                </div>
                <!-- å³ä¾§ï¼šYOLOå¤„ç†åçš„å›¾åƒ -->
                <div class="video-card">
                    <div class="video-card-header">
                        <h3>ğŸ”¬ YOLOç¼ºé™·æ£€æµ‹ç»“æœ</h3>
                    </div>
                    <div class="video-card-body">
                        <img id="yoloResult" class="video-frame" src="" alt="YOLOæ£€æµ‹ç»“æœ">
                    </div>
                </div>
            </div>

            <!-- ä¸‹åŠéƒ¨åˆ†ï¼šç¼ºé™·ä¿¡æ¯åˆ—è¡¨ -->
            <div class="video-bottom">
                <div class="video-bottom-header">
                    <h3>ğŸ“‹ ç¼ºé™·ä¿¡æ¯åˆ—è¡¨</h3>
                </div>
                <div class="defect-list-container" id="defectList">
                    <div class="no-defect-message">æš‚æ— ç¼ºé™·ä¿¡æ¯ï¼Œè¯·ç‚¹å‡»"è¯†åˆ«ç¼ºé™·"</div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‘„åƒå¤´é€‰æ‹©æ¨¡æ€æ¡† - è´´å·¦è¾¹æ‚¬æµ® -->
    <div id="cameraModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>é€‰æ‹©æ‘„åƒå¤´</h3>
                <span class="modal-close" onclick="cancelCameraSelection()">&times;</span>
            </div>
            <div class="modal-body">
                <p style="color: #b0c4de; margin-bottom: 15px;">æ£€æµ‹åˆ°å¤šä¸ªæ‘„åƒå¤´ï¼š</p>
                <div id="cameraOptions" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- é€‰é¡¹ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                </div>
                <div class="modal-footer">
                    <button class="video-btn" onclick="cancelCameraSelection()" style="background: #4a4f62; border-color: #6a7085;">å–æ¶ˆ</button>
                    <button class="video-btn primary" onclick="confirmCameraSelection()">ç¡®å®š</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æç¤ºæ¶ˆæ¯å®¹å™¨ -->
    <div id="toast" class="toast"></div>

    <script>
        // è§†é¢‘æ£€æµ‹JavaScript
        const video = document.createElement('video');
        let mediaStream = null;
        let sessionId = null;
        let isCameraActive = false;
        let animationFrame = null;
        let saveCount = 0;
        let hasYoloResult = false;  // æ ‡è®°æ˜¯å¦æœ‰YOLOæ£€æµ‹ç»“æœ
        let lastSavedDetection = null;  // è®°å½•ä¸Šæ¬¡ä¿å­˜çš„æ£€æµ‹ç»“æœï¼Œé˜²æ­¢é‡å¤ä¿å­˜

        // æ‘„åƒå¤´é€‰æ‹©ç›¸å…³å˜é‡
        let pendingResolve = null;  // ç”¨äºä¿å­˜ Promise çš„ resolve å‡½æ•°
        let selectedDeviceId = null;

        // DOMå…ƒç´ 
        const cameraFeed = document.getElementById('cameraFeed');
        const yoloResult = document.getElementById('yoloResult');
        const defectList = document.getElementById('defectList');
        const startCameraBtn = document.getElementById('startCameraBtn');
        const stopCameraBtn = document.getElementById('stopCameraBtn');
        const detectBtn = document.getElementById('detectBtn');
        const saveBtn = document.getElementById('saveBtn');
        const cameraStatus = document.getElementById('cameraStatus');
        const boardStatus = document.getElementById('boardStatus');
        const yoloStatus = document.getElementById('yoloStatus');
        const defectCountSpan = document.getElementById('defectCount');
        const saveCountSpan = document.getElementById('saveCount');

        // ç”Ÿæˆä¼šè¯ID
        function generateSessionId() {
            return 'video_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // æ›´æ–°ä¿å­˜æŒ‰é’®çŠ¶æ€
        function updateSaveButton() {
            // ä¿å­˜æŒ‰é’®å¯ç”¨æ¡ä»¶ï¼šæœ‰YOLOæ£€æµ‹ç»“æœ ä¸” å½“å‰æ£€æµ‹ç»“æœä¸ä¸Šæ¬¡ä¿å­˜çš„ä¸åŒ
            if (hasYoloResult && lastSavedDetection !== sessionId + '_' + hasYoloResult) {
                saveBtn.disabled = false;
            } else {
                saveBtn.disabled = true;
            }
        }

        // æ˜¾ç¤ºæ‘„åƒå¤´é€‰æ‹©æ¨¡æ€æ¡†
        function showCameraModal(devices) {
            return new Promise((resolve) => {
                pendingResolve = resolve;
                selectedDeviceId = null;

                const modal = document.getElementById('cameraModal');
                const optionsDiv = document.getElementById('cameraOptions');

                // æ¸…ç©ºå¹¶æ·»åŠ é€‰é¡¹
                optionsDiv.innerHTML = '';

                devices.forEach((device, index) => {
                    const deviceName = device.label || `æ‘„åƒå¤´ ${index + 1}`;
                    const isDefault = index === 0;

                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'camera-option' + (isDefault ? ' selected' : '');

                    // å¦‚æœæ˜¯é»˜è®¤é€‰é¡¹ï¼Œè®¾ç½®selectedDeviceId
                    if (isDefault) {
                        selectedDeviceId = device.deviceId;
                    }

                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = 'camera';
                    radio.value = device.deviceId;
                    radio.checked = isDefault;
                    radio.onchange = () => selectCameraOption(device.deviceId);

                    const label = document.createElement('label');
                    label.innerHTML = `
                        <span>${deviceName}</span>
                        <span class="camera-badge">${index === 0 ? 'æ¨è' : ''}</span>
                    `;

                    optionDiv.appendChild(radio);
                    optionDiv.appendChild(label);

                    optionDiv.onclick = (e) => {
                        if (e.target !== radio) {
                            radio.checked = true;
                            selectCameraOption(device.deviceId);
                        }
                    };

                    optionsDiv.appendChild(optionDiv);
                });

                modal.style.display = 'flex';
            });
        }

        // é€‰æ‹©æ‘„åƒå¤´é€‰é¡¹
        function selectCameraOption(deviceId) {
            selectedDeviceId = deviceId;

            // æ›´æ–°é€‰ä¸­æ ·å¼
            document.querySelectorAll('.camera-option').forEach(opt => {
                opt.classList.remove('selected');
                const radio = opt.querySelector('input[type="radio"]');
                if (radio && radio.value === deviceId) {
                    opt.classList.add('selected');
                }
            });
        }

        // ç¡®è®¤é€‰æ‹©æ‘„åƒå¤´
        function confirmCameraSelection() {
            if (selectedDeviceId) {
                const modal = document.getElementById('cameraModal');
                modal.style.display = 'none';

                if (pendingResolve) {
                    pendingResolve(selectedDeviceId);
                    pendingResolve = null;
                }
                selectedDeviceId = null;
            } else {
                showToast('è¯·é€‰æ‹©ä¸€ä¸ªæ‘„åƒå¤´', 'error');
            }
        }

        // å–æ¶ˆé€‰æ‹©æ‘„åƒå¤´
        function cancelCameraSelection() {
            const modal = document.getElementById('cameraModal');
            modal.style.display = 'none';

            if (pendingResolve) {
                pendingResolve(null);
                pendingResolve = null;
            }
            selectedDeviceId = null;
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('cameraModal');
            if (event.target === modal) {
                cancelCameraSelection();
            }
        };

        // å¯åŠ¨æ‘„åƒå¤´
        startCameraBtn.addEventListener('click', async () => {
            try {
                // å…ˆå¼ºåˆ¶åœæ­¢ä»»ä½•å¯èƒ½å­˜åœ¨çš„æµ
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }
                if (video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                    video.srcObject = null;
                }

                // è·å–æ‰€æœ‰æ‘„åƒå¤´è®¾å¤‡
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(d => d.kind === 'videoinput');

                if (videoDevices.length === 0) {
                    throw new Error('æœªæ£€æµ‹åˆ°æ‘„åƒå¤´è®¾å¤‡');
                }

                console.log('æ‰¾åˆ°æ‘„åƒå¤´:', videoDevices.map(d => d.label || 'æœªçŸ¥'));

                // å¦‚æœæœ‰å¤šä¸ªæ‘„åƒå¤´ï¼Œæ˜¾ç¤ºé€‰æ‹©å¼¹çª—
                let selectedDeviceId = null;
                if (videoDevices.length > 1) {
                    showToast('æ£€æµ‹åˆ°å¤šä¸ªæ‘„åƒå¤´ï¼Œè¯·é€‰æ‹©è¦ä½¿ç”¨çš„è®¾å¤‡', 'info');
                    selectedDeviceId = await showCameraModal(videoDevices);

                    // å¦‚æœç”¨æˆ·å–æ¶ˆé€‰æ‹©ï¼Œç›´æ¥è¿”å›
                    if (!selectedDeviceId) {
                        showToast('å·²å–æ¶ˆæ‘„åƒå¤´é€‰æ‹©', 'info');
                        return;
                    }
                } else {
                    selectedDeviceId = videoDevices[0].deviceId;
                }

                // å°è¯•æ‘„åƒå¤´é…ç½®
                let stream = null;
                let lastError = null;

                // å…ˆå°è¯•ç”¨æˆ·é€‰æ‹©çš„è®¾å¤‡
                try {
                    console.log('å°è¯•é€‰æ‹©çš„è®¾å¤‡');
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            deviceId: { exact: selectedDeviceId },
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        }
                    });
                    console.log('é€‰æ‹©çš„è®¾å¤‡æˆåŠŸ');
                } catch (e) {
                    console.warn('é€‰æ‹©çš„è®¾å¤‡å¤±è´¥:', e.message);
                    lastError = e;
                }

                // å¦‚æœé€‰æ‹©çš„è®¾å¤‡å¤±è´¥ï¼Œé€ä¸ªå°è¯•å…¶ä»–è®¾å¤‡
                if (!stream) {
                    for (const device of videoDevices) {
                        if (device.deviceId === selectedDeviceId) continue; // å·²ç»è¯•è¿‡äº†

                        try {
                            console.log('å°è¯•å¤‡ç”¨è®¾å¤‡:', device.label || 'æœªçŸ¥');
                            stream = await navigator.mediaDevices.getUserMedia({
                                video: {
                                    deviceId: { exact: device.deviceId },
                                    width: { ideal: 640 },
                                    height: { ideal: 480 }
                                }
                            });
                            console.log('å¤‡ç”¨è®¾å¤‡æˆåŠŸ:', device.label || 'æœªçŸ¥');
                            break;
                        } catch (e) {
                            console.warn('å¤‡ç”¨è®¾å¤‡å¤±è´¥:', device.label || 'æœªçŸ¥', e.message);
                            lastError = e;
                        }
                    }
                }

                // æœ€åå°è¯•ä¸å¸¦ deviceId çš„é…ç½®
                if (!stream) {
                    const constraintsList = [
                        { video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: 'environment' } },
                        { video: { width: { ideal: 640 }, height: { ideal: 480 } } },
                        { video: true }
                    ];

                    for (const constraints of constraintsList) {
                        try {
                            console.log('å°è¯•é€šç”¨é…ç½®:', constraints);
                            stream = await navigator.mediaDevices.getUserMedia(constraints);
                            console.log('é€šç”¨é…ç½®æˆåŠŸ');
                            break;
                        } catch (e) {
                            console.warn('é€šç”¨é…ç½®å¤±è´¥:', e.message);
                            lastError = e;
                        }
                    }
                }

                if (!stream) {
                    throw lastError || new Error('æ‰€æœ‰æ‘„åƒå¤´é…ç½®éƒ½å¤±è´¥');
                }

                // æˆåŠŸè·å–æµ
                video.srcObject = stream;
                await video.play();

                mediaStream = stream;

                // æ˜¾ç¤ºå½“å‰ä½¿ç”¨çš„æ‘„åƒå¤´ä¿¡æ¯
                const track = stream.getVideoTracks()[0];
                const settings = track.getSettings();
                const deviceLabel = track.label;
                console.log('å½“å‰ä½¿ç”¨æ‘„åƒå¤´:', deviceLabel);
                console.log('æ‘„åƒå¤´è®¾ç½®:', settings);

                // åˆ›å»ºä¼šè¯
                sessionId = generateSessionId();

                // å¯åŠ¨å¸§å¤„ç†
                isCameraActive = true;
                processVideoFrame();

                // æ›´æ–°UI
                startCameraBtn.disabled = true;
                stopCameraBtn.disabled = false;
                detectBtn.disabled = false;
                cameraStatus.textContent = `å·²è¿æ¥ (${deviceLabel.split(' ')[0] || 'æ‘„åƒå¤´'})`;
                cameraStatus.style.color = '#4f9e7a';

                showToast(`æ‘„åƒå¤´å¯åŠ¨æˆåŠŸ: ${deviceLabel}`, 'success');

            } catch (error) {
                console.error('æ‘„åƒå¤´å¯åŠ¨å¤±è´¥:', error);

                let errorMessage = 'æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: ';
                if (error.name === 'NotReadableError') {
                    errorMessage += 'æ‘„åƒå¤´è¢«å…¶ä»–åº”ç”¨å ç”¨ï¼Œè¯·å…³é—­å…¶ä»–ä½¿ç”¨æ‘„åƒå¤´çš„ç¨‹åº';
                } else {
                    errorMessage += error.message;
                }

                showToast(errorMessage, 'error');

                cameraStatus.textContent = 'è¿æ¥å¤±è´¥';
                cameraStatus.style.color = '#f05454';
                startCameraBtn.disabled = false;
                stopCameraBtn.disabled = true;
            }
        });

        // åœæ­¢æ‘„åƒå¤´
        stopCameraBtn.addEventListener('click', () => {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }

            video.srcObject = null;
            isCameraActive = false;
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
                animationFrame = null;
            }

            // æ¸…é™¤ä¼šè¯
            if (sessionId) {
                fetch('/api/video/clear_session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });
                sessionId = null;
            }

            // æ›´æ–°UI
            startCameraBtn.disabled = false;
            stopCameraBtn.disabled = true;
            detectBtn.disabled = true;
            saveBtn.disabled = true;
            cameraStatus.textContent = 'æœªè¿æ¥';
            cameraStatus.style.color = '';
            boardStatus.textContent = 'æœªæ£€æµ‹';
            boardStatus.className = 'status-value';
            yoloStatus.textContent = 'æœªæ£€æµ‹';
            yoloStatus.className = 'status-value';

            cameraFeed.src = '';
            yoloResult.src = '';

            showToast('æ‘„åƒå¤´å·²å…³é—­', 'info');
        });

        // å¤„ç†è§†é¢‘å¸§
        async function processVideoFrame() {
            if (!isCameraActive || !video.videoWidth || !sessionId) {
                animationFrame = requestAnimationFrame(processVideoFrame);
                return;
            }

            // åˆ›å»ºç”»å¸ƒå¹¶ç»˜åˆ¶å½“å‰å¸§
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // è½¬æ¢ä¸ºbase64
            const imageData = canvas.toDataURL('image/jpeg', 0.8);

            try {
                // å‘é€åˆ°åç«¯å¤„ç†
                const response = await fetch('/api/video/process_frame', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        image: imageData
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // æ›´æ–°æ‘„åƒå¤´ç”»é¢
                    cameraFeed.src = result.processed_image;

                    // æ›´æ–°ç”µè·¯æ¿æ£€æµ‹çŠ¶æ€
                    if (result.has_board) {
                        boardStatus.textContent = 'å·²æ£€æµ‹åˆ°';
                        boardStatus.className = 'status-value has-board';
                        detectBtn.disabled = false;  // æ£€æµ‹åˆ°ç”µè·¯æ¿åæ‰èƒ½è¿›è¡ŒYOLOæ£€æµ‹
                    } else {
                        boardStatus.textContent = 'æœªæ£€æµ‹åˆ°';
                        boardStatus.className = 'status-value no-board';
                        detectBtn.disabled = true;  // æ²¡æœ‰ç”µè·¯æ¿æ—¶ç¦ç”¨è¯†åˆ«æŒ‰é’®
                    }
                }
            } catch (error) {
                console.error('å¤„ç†å¸§å¤±è´¥:', error);
            }

            animationFrame = requestAnimationFrame(processVideoFrame);
        }

        // è¯†åˆ«ç¼ºé™·
        detectBtn.addEventListener('click', async () => {
            if (!sessionId) {
                showToast('è¯·å…ˆå¯åŠ¨æ‘„åƒå¤´', 'error');
                return;
            }

            detectBtn.disabled = true;
            detectBtn.innerHTML = 'â³ è¯†åˆ«ä¸­...';

            try {
                const response = await fetch('/api/video/detect_defect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });

                const result = await response.json();

                if (result.success) {
                    // æ›´æ–°YOLOç»“æœå›¾åƒ
                    yoloResult.src = result.yolo_image;

                    // æ›´æ–°ç¼ºé™·åˆ—è¡¨
                    updateDefectList(result.detections);

                    // æ›´æ–°ç¼ºé™·æ•°é‡
                    defectCountSpan.textContent = result.detections.length;

                    // æ›´æ–°YOLOæ£€æµ‹çŠ¶æ€
                    hasYoloResult = true;
                    yoloStatus.textContent = 'å·²æ£€æµ‹';
                    yoloStatus.className = 'status-value has-detection';

                    // é‡ç½®ä¸Šæ¬¡ä¿å­˜çš„è®°å½•ï¼Œå…è®¸ä¿å­˜è¿™ä¸ªæ–°çš„æ£€æµ‹ç»“æœ
                    lastSavedDetection = null;

                    // æ›´æ–°ä¿å­˜æŒ‰é’®çŠ¶æ€
                    updateSaveButton();

                    showToast('ç¼ºé™·è¯†åˆ«å®Œæˆ', 'success');
                } else {
                    showToast(result.error || 'è¯†åˆ«å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('è¯†åˆ«å¤±è´¥:', error);
                showToast('è¯†åˆ«å¤±è´¥: ' + error.message, 'error');
            } finally {
                detectBtn.disabled = false;
                detectBtn.innerHTML = 'ğŸ” è¯†åˆ«ç¼ºé™·';
            }
        });

        // ä¿å­˜ç»“æœ
        saveBtn.addEventListener('click', async () => {
            if (!sessionId) {
                showToast('è¯·å…ˆå¯åŠ¨æ‘„åƒå¤´', 'error');
                return;
            }

            saveBtn.disabled = true;
            saveBtn.innerHTML = 'â³ ä¿å­˜ä¸­...';

            try {
                const response = await fetch('/api/video/save_result', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });

                const result = await response.json();

                if (result.success) {
                    saveCount++;
                    saveCountSpan.textContent = saveCount;

                    // è®°å½•è¿™æ¬¡ä¿å­˜çš„æ£€æµ‹ç»“æœï¼Œé˜²æ­¢é‡å¤ä¿å­˜
                    lastSavedDetection = sessionId + '_' + hasYoloResult;

                    // æ›´æ–°ä¿å­˜æŒ‰é’®çŠ¶æ€
                    updateSaveButton();

                    showToast('ä¿å­˜æˆåŠŸ', 'success');
                } else {
                    showToast(result.error || 'ä¿å­˜å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = 'ğŸ’¾ ä¿å­˜ç»“æœ';
                // æ³¨æ„ï¼šè¿™é‡Œé‡æ–°å¯ç”¨ä¿å­˜æŒ‰é’®ï¼Œä½†updateSaveButton()ä¼šæ ¹æ®æ¡ä»¶å†³å®šæ˜¯å¦çœŸçš„å¯ç”¨
                updateSaveButton();
            }
        });

        // æ›´æ–°ç¼ºé™·åˆ—è¡¨
        function updateDefectList(detections) {
            if (!detections || detections.length === 0) {
                defectList.innerHTML = '<div class="no-defect-message">æœªæ£€æµ‹åˆ°ç¼ºé™·</div>';
                return;
            }

            let html = '';
            detections.forEach(defect => {
                const defectClass = defect.defect_type_en || 'missing_hole';
                html += `
                    <div class="defect-item ${defectClass}">
                        <div class="defect-detail">
                            <span class="defect-label">ç±»å‹</span>
                            <span class="defect-value">${defect.defect_type}</span>
                        </div>
                        <div class="defect-detail">
                            <span class="defect-label">ç½®ä¿¡åº¦</span>
                            <span class="defect-value">${(defect.confidence * 100).toFixed(1)}%</span>
                        </div>
                        <div class="defect-detail">
                            <span class="defect-label">ä½ç½®</span>
                            <span class="defect-value">[${defect.coordinates[0]}, ${defect.coordinates[1]}]</span>
                        </div>
                        <div class="defect-detail">
                            <span class="defect-label">å°ºå¯¸</span>
                            <span class="defect-value">${defect.width} x ${defect.height}</span>
                        </div>
                    </div>
                `;
            });

            defectList.innerHTML = html;
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'info') {
            let toast = document.getElementById('toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast';
                toast.className = 'toast';
                document.body.appendChild(toast);
            }

            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // é¡µé¢å…³é—­å‰æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>